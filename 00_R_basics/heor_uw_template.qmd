---
title: "HEOR Analysis Template — University of Washington Style"
author: "Carlos Pineda"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    df-print: paged
    theme: flatly
    css: uw-theme.css
    highlight: textmate
  pdf:
    toc: true
    number-sections: true
    geometry: margin=1in
    include-in-header: uw-pdf-header.tex
execute:
  echo: true
  warning: false
  message: false
editor: source
---

> **Note:** This Quarto template is styled with University of Washington purple/gold accents.
> To render PDF, ensure a LaTeX distribution (e.g., TinyTeX) is installed.

# Project Setup

Create a **Quarto project** (optional) and a simple folder structure:

```
/project-root
  ├─ data/
  │   └─ claims_synthetic.csv
  ├─ outputs/
  └─ heor_uw_template.qmd  (this file)
```

Set a CRAN mirror and load packages commonly used in **HEOR**:

```{r}
options(repos = c(CRAN = "https://cloud.r-project.org"))
# install.packages(c("tidyverse","lubridate","janitor","broom","survival","MatchIt"))
library(tidyverse); library(lubridate); library(janitor)
library(broom); library(survival); library(MatchIt)
```

# Data (Synthetic Claims/EHR)

This template ships with a small **synthetic** claims/EHR CSV (no PHI).

```{r}
claims <- readr::read_csv("data/claims_synthetic.csv",
  col_types = readr::cols(
    patient_id = readr::col_character(),
    sex = readr::col_factor(levels = c("F","M")),
    birth_date = readr::col_date(),
    index_date = readr::col_date(),
    encounter_type = readr::col_factor(levels = c("OP","ED","IP","RX")),
    icd10 = readr::col_character(),
    cpt = readr::col_character(),
    ndc = readr::col_character(),
    admit_date = readr::col_date(),
    discharge_date = readr::col_date(),
    days_supply = readr::col_double(),
    quantity = readr::col_double(),
    paid_amount = readr::col_double(),
    allowed_amount = readr::col_double(),
    payer = readr::col_factor(),
    place_of_service = readr::col_factor(),
    provider_specialty = readr::col_factor()
))
glimpse(claims)
```

# Derivations and Common HEOR Measures

```{r}
claims <- claims |>
  mutate(
    lookback_start = index_date - lubridate::days(180),
    post_period_end = index_date + lubridate::days(180)
  )

claims <- claims |>
  group_by(patient_id) |>
  mutate(cohort_flag = if_else(runif(1) > 0.5, 1, 0)) |>
  ungroup()

# Comorbidity proxy (very simplified — ICD chapter = first letter)
icd_chapter <- function(code) substr(code, 1, 1)
lb <- claims |>
  filter(encounter_type != "RX") |>
  filter(admit_date >= lookback_start, admit_date < index_date) |>
  mutate(chapter = icd_chapter(icd10)) |>
  group_by(patient_id) |>
  summarise(comorbidity_chapters = n_distinct(chapter), .groups = "drop")

# Utilization & LOS
util <- claims |>
  mutate(LOS = as.numeric(discharge_date - admit_date + 1L)) |>
  summarise(
    OP_visits = sum(encounter_type == "OP", na.rm = TRUE),
    ED_visits = sum(encounter_type == "ED", na.rm = TRUE),
    IP_admits = sum(encounter_type == "IP", na.rm = TRUE),
    IP_LOS_days = sum(if_else(encounter_type == "IP", pmax(0, LOS), 0), na.rm = TRUE),
    .by = patient_id
  )

# Costs pre/post
costs <- claims |>
  mutate(period = case_when(
    admit_date >= lookback_start & admit_date < index_date ~ "pre",
    admit_date >= index_date & admit_date <= post_period_end ~ "post",
    TRUE ~ "other"
  )) |>
  summarise(total_paid = sum(paid_amount, na.rm = TRUE), .by = c(patient_id, period)) |>
  tidyr::pivot_wider(names_from = period, values_from = total_paid, values_fill = 0)

# PDC adherence (post-index)
pdc <- claims |>
  filter(encounter_type == "RX", ndc != "") |>
  filter(admit_date >= index_date, admit_date <= post_period_end) |>
  mutate(end = admit_date + lubridate::days(days_supply) - lubridate::days(1)) |>
  group_by(patient_id) |>
  summarise(
    days_covered = as.numeric(sum(pmin(end, post_period_end) - pmax(admit_date, index_date) + 1)),
    pdc_180 = pmin(1, days_covered / 180),
    .groups = "drop"
  )

heor_base <- lb |>
  full_join(util, by = "patient_id") |>
  full_join(costs, by = "patient_id") |>
  full_join(pdc, by = "patient_id") |>
  replace_na(list(OP_visits=0, ED_visits=0, IP_admits=0, IP_LOS_days=0, pre=0, post=0, pdc_180=0))

glimpse(heor_base)
```

# Analyses

## Two-Part Cost Model

```{r}
heor_base <- heor_base |>
  mutate(any_post_cost = as.integer(post > 0))

part1 <- glm(any_post_cost ~ comorbidity_chapters + OP_visits + ED_visits + IP_admits,
             data = heor_base, family = binomial())

pos <- dplyr::filter(heor_base, post > 0)
part2 <- glm(post ~ comorbidity_chapters + OP_visits + ED_visits + IP_admits,
             data = pos, family = Gamma(link = "log"))

broom::tidy(part1)
broom::tidy(part2)
```

## Time-to-Event (First ED Visit)

```{r}
tte <- claims |>
  filter(encounter_type == "ED") |>
  group_by(patient_id) |>
  summarise(first_ed = min(admit_date[admit_date >= first(index_date)]), .groups = "drop") |>
  right_join(claims |> distinct(patient_id, index_date), by = "patient_id") |>
  mutate(
    time = as.numeric(coalesce(first_ed, index_date + 180) - index_date),
    status = as.integer(!is.na(first_ed))
  )

km <- survival::survfit(Surv(time, status) ~ 1, data = tte)
summary(km)
```

## Propensity Score Matching

```{r}
coh <- heor_base |>
  left_join(claims |> distinct(patient_id, cohort_flag), by = "patient_id") |>
  mutate(cohort_flag = as.integer(cohort_flag))

m.out <- MatchIt::matchit(cohort_flag ~ comorbidity_chapters + OP_visits + ED_visits + IP_admits,
                          data = coh, method = "nearest", ratio = 1)
matched <- MatchIt::match.data(m.out)
dplyr::count(matched, cohort_flag)
```

## Difference-in-Differences (Naïve Contrast)

```{r}
did <- heor_base |>
  select(patient_id, pre, post) |>
  left_join(claims |> distinct(patient_id, cohort_flag), by = "patient_id") |>
  mutate(diff = post - pre, cohort_flag = as.integer(cohort_flag))

with(did, mean(diff[cohort_flag == 1], na.rm = TRUE) - mean(diff[cohort_flag == 0], na.rm = TRUE))
```

# Visualization

```{r}
ggplot(heor_base, aes(x = pdc_180)) +
  geom_histogram(bins = 20) +
  labs(title = "Medication Adherence (PDC over 180 days)", x = "PDC", y = "Count")
```

# Saving Outputs

```{r}
#readr::write_csv(heor_base, "outputs/heor_base.csv")
#saveRDS(heor_base, "outputs/heor_base.rds")
```

# References & Help

- **Cheat sheets:** *RStudio* → *Help* → *Cheatsheets*
- **Vignettes:** `browseVignettes()`, `vignette(package = "survival")`
- **Docs:** Quarto User Guide, R for Data Science (2e)
